{% extends "base.html" %}
{% block title %}Teacher Analytics{% endblock %}
{% block body_class %}analytics-section{% endblock %}
{% block content %}
<section class="panel">
  <h2>üìà Class Analytics & Insights</h2>

  <div class="analytics-container">
    <!-- Attendance Overview -->
    <div class="analytics-card">
      <div class="card-header">
        <h3>Attendance Overview</h3>
      </div>
      <div class="card-body">
        <canvas id="attendanceChart"></canvas>
        <div class="stats-grid">
          <div class="stat-box">
            <span class="stat-number" id="avgAttendance">0%</span>
            <span class="stat-label">Average Attendance</span>
          </div>
          <div class="stat-box">
            <span class="stat-number" id="totalClasses">0</span>
            <span class="stat-label">Total Classes</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Homework Statistics -->
    <div class="analytics-card">
      <div class="card-header">
        <h3>Homework Statistics</h3>
      </div>
      <div class="card-body">
        <canvas id="homeworkChart"></canvas>
        <div class="stats-grid">
          <div class="stat-box">
            <span class="stat-number" id="totalHomeworks">0</span>
            <span class="stat-label">Total Assignments</span>
          </div>
          <div class="stat-box">
            <span class="stat-number" id="avgGrade">0</span>
            <span class="stat-label">Average Grade</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Performance -->
    <div class="analytics-card full-width">
      <div class="card-header">
        <h3>Student Performance Ranking</h3>
        <div class="form-row" style="margin: 0;">
          <label for="performanceMetric" style="color: white;">Metric:</label>
          <select id="performanceMetric" onchange="loadStudentPerformance()">
            <option value="attendance">By Attendance</option>
            <option value="homework">By Homework Grades</option>
            <option value="participation">By Participation</option>
          </select>
        </div>
      </div>
      <div class="card-body">
        <table class="table" id="performanceTable">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Roll No</th>
              <th>Name</th>
              <th>Score</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="performanceBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Subject-wise Analysis -->
    <div class="analytics-card full-width">
      <div class="card-header">
        <h3>Subject-wise Analysis</h3>
      </div>
      <div class="card-body">
        <table class="table">
          <thead>
            <tr>
              <th>Subject</th>
              <th>Avg Attendance</th>
              <th>Homeworks Posted</th>
              <th>Avg Grade</th>
              <th>Pending Doubts</th>
            </tr>
          </thead>
          <tbody id="subjectAnalysisBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Low Performers Alert -->
    <div class="analytics-card full-width alert-card">
      <div class="card-header alert">
        <h3>‚ö†Ô∏è Students Needing Attention</h3>
      </div>
      <div class="card-body">
        <div id="lowPerformersArea"></div>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
let attendanceChart, homeworkChart;

document.addEventListener('DOMContentLoaded', async function() {
  await loadAnalytics();
  await loadStudentPerformance();
});

async function loadAnalytics() {
  try {
    const response = await fetch('/api/teacher/analytics');
    const data = await response.json();

    if (data.ok) {
      updateAttendanceChart(data.attendance);
      updateHomeworkChart(data.homework);
      updateSubjectAnalysis(data.subjects);
      updateLowPerformers(data.low_performers);
      updateOverallStats(data.overall);
    }
  } catch (error) {
    console.error('Error loading analytics:', error);
  }
}

function updateOverallStats(stats) {
  document.getElementById('avgAttendance').textContent = stats.avg_attendance + '%';
  document.getElementById('totalClasses').textContent = stats.total_classes;
  document.getElementById('totalHomeworks').textContent = stats.total_homeworks;
  document.getElementById('avgGrade').textContent = stats.avg_grade || 'N/A';
}

function updateAttendanceChart(data) {
  const ctx = document.getElementById('attendanceChart').getContext('2d');

  if (attendanceChart) attendanceChart.destroy();

  attendanceChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Present', 'Absent (Informed)', 'Absent (Uninformed)'],
      datasets: [{
        data: [data.present, data.absent_informed, data.absent_uninformed],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {position: 'bottom'}
      }
    }
  });
}

function updateHomeworkChart(data) {
  const ctx = document.getElementById('homeworkChart').getContext('2d');

  if (homeworkChart) homeworkChart.destroy();

  homeworkChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Pending', 'Submitted', 'Graded'],
      datasets: [{
        label: 'Submissions',
        data: [data.pending, data.submitted, data.graded],
        backgroundColor: ['#ffc107', '#17a2b8', '#28a745'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {display: false}
      },
      scales: {
        y: {beginAtZero: true}
      }
    }
  });
}

function updateSubjectAnalysis(subjects) {
  const tbody = document.getElementById('subjectAnalysisBody');

  if (subjects.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
    return;
  }

  tbody.innerHTML = subjects.map(s => `
    <tr>
      <td>${s.name}</td>
      <td>${s.avg_attendance}%</td>
      <td>${s.homeworks_count}</td>
      <td>${s.avg_grade || 'N/A'}</td>
      <td>${s.pending_doubts}</td>
    </tr>
  `).join('');
}

function updateLowPerformers(students) {
  const area = document.getElementById('lowPerformersArea');

  if (students.length === 0) {
    area.innerHTML = '<p style="text-align: center; color: #28a745;">All students are performing well! üéâ</p>';
    return;
  }

  area.innerHTML = students.map(s => `
    <div class="alert-item">
      <div class="alert-student">
        <strong>${s.name}</strong> (${s.roll_no})
      </div>
      <div class="alert-reasons">
        ${s.reasons.map(r => `<span class="reason-badge">${r}</span>`).join('')}
      </div>
    </div>
  `).join('');
}

async function loadStudentPerformance() {
  const metric = document.getElementById('performanceMetric').value;

  try {
    const response = await fetch(`/api/teacher/performance?metric=${metric}`);
    const data = await response.json();

    if (data.ok) {
      displayPerformance(data.students);
    }
  } catch (error) {
    console.error('Error loading performance:', error);
  }
}

function displayPerformance(students) {
  const tbody = document.getElementById('performanceBody');

  if (students.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data available</td></tr>';
    return;
  }

  tbody.innerHTML = students.map((s, index) => {
    const rankClass = index < 3 ? 'rank-top' : index >= students.length - 3 ? 'rank-bottom' : '';
    const statusClass = s.score >= 80 ? 'excellent' : s.score >= 60 ? 'good' : 'needs-improvement';
    const statusText = s.score >= 80 ? 'Excellent' : s.score >= 60 ? 'Good' : 'Needs Attention';

    return `
      <tr class="${rankClass}">
        <td>${index + 1}</td>
        <td>${s.roll_no}</td>
        <td>${s.name}</td>
        <td><strong>${s.score}${s.unit || ''}</strong></td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
      </tr>
    `;
  }).join('');
}
</script>

<style>
.analytics-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.analytics-card {
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.analytics-card.full-width {
  grid-column: 1 / -1;
}

.analytics-card .card-header {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.analytics-card.alert-card .card-header {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.analytics-card .card-header h3 {
  margin: 0;
  font-size: 1.2em;
}

.analytics-card .card-body {
  padding: 20px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 20px;
}

.stat-box {
  text-align: center;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 8px;
}

.stat-number {
  display: block;
  font-size: 2em;
  font-weight: bold;
  color: #f5576c;
}

.stat-label {
  display: block;
  font-size: 0.9em;
  color: #666;
  margin-top: 5px;
}

.alert-item {
  background: #fff3cd;
  border-left: 4px solid #dc3545;
  padding: 15px;
  margin-bottom: 10px;
  border-radius: 4px;
}

.alert-student {
  margin-bottom: 10px;
  color: #333;
}

.alert-reasons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.reason-badge {
  background: #dc3545;
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.85em;
}

.rank-top {
  background: #d4edda !important;
}

.rank-bottom {
  background: #f8d7da !important;
}

.status-badge {
  padding: 5px 10px;
  border-radius: 4px;
  font-size: 0.85em;
  font-weight: 500;
}

.status-badge.excellent {
  background: #d4edda;
  color: #155724;
}

.status-badge.good {
  background: #d1ecf1;
  color: #0c5460;
}

.status-badge.needs-improvement {
  background: #f8d7da;
  color: #721c24;
}
</style>
{% endblock %}
